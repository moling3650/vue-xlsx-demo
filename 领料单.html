<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>领料单导出</title>
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <script src="static/js/vue.min.js"></script>
  <script src="static/js/xlsx.full.min.js"></script>
  <script src="static/js/common.js"></script>
</head>
<body>
  <div id="app" class="container">
    <div class="row">
      <div class="col-xs-6">
        <form class="form-inline">
          <div class="form-group">
            <label for="file">选择领料单 </label>
            <input type="file" class="form-control" id="file" :accept="SheetJSFT" @change="handleChange" />
          </div>
        </form>
      </div>
      <button class="btn btn-success" @click="exportData">导出领料单</button>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead>
              <tr>
                <th v-for="col in cols" :key="col">{{ col }}</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(r, key) in data" :key="key">
                <td v-for="col in cols" :key="col"> {{ r[col] }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const _SheetJSFT = [
      'xlsx', 'xlsb', 'xlsm', 'xls', 'xml', 'csv', 'txt', 'ods', 'fods', 'uos', 'sylk', 'dif', 'dbf', 'prn', 'qpw', '123', 'wb*', 'wq*', 'html', 'htm'
    ].map(x => `.${x}`).join(',')

    new Vue({
      el: '#app',
      data () {
        return {
          SheetJSFT: _SheetJSFT,
          cols: [],
          orders: new Set(),
          orderProducts: new Map(),
          data: []
        }
      },
      methods: {
        handleChange (e) {
          const files = e.target.files
          if (files && files[0]) {
            this._loadFile(files[0])
          }
        },
        _loadFile (file) {
          const reader = new FileReader()
          reader.onload = (e) => {
            /* Parse data */
            const bstr = e.target.result
            const wb = XLSX.read(bstr, { type: 'binary' })
            /* Get first worksheet */
            const wsname = wb.SheetNames[0]
            const ws = wb.Sheets[wsname]
            if (!ws.O2 || ws.O2.v !== '领料单') {
              return void alert('请选择正确格式的领料单')
            }
            const department = ws.B6.v
            const date = ws.R7.v
            // /* Convert array of arrays */
            const newData = XLSX.utils.sheet_to_json(ws, { header: 1 }).filter(r => parseInt(r[0]) >= 0)
            newData.forEach(row => {
              const key = `${row[26]}__${row[9]}`
              this.orderProducts.set(key, {
                taskOrder: row[26],
                product: row[9],
                department,
                date
              })
            })
            // /* Update state */
            const data = JSON.parse(JSON.stringify(this.data))

            newData.forEach(row => {
              const index = data.findIndex(item => item['物料代码'] === row[1])
              const order = row[26]
              if (~index) {
                data[index][order] = row[13]
                if (!this.orders.has(order) && row[19]) {
                  data[index]['替代状况'] += (data[index]['替代状况'] ? ' / ' : '') + row[19].trim()
                }
              } else {
                const item = {
                  '序号': data.length + 1,
                  '物料代码': row[1],
                  '物料名称': row[2],
                  '规格型号': row[3],
                  '替代状况': row[19]
                }
                item[order] = row[13]
                data.push(item)
              }
            })
            this.orders = new Set([...this.orderProducts.values()].map(item => item.taskOrder))
            this.data = data
            this.cols = ['序号', '物料代码', '物料名称', '规格型号', '替代状况', ...this.orders]
          }
          reader.readAsBinaryString(file)
        },
        exportData () {
          const data = [
            ['爱科通电子（深圳）有限公司'],
            ['领  料  单'],
            ['序号', '任务单号', '产品代码', '规格型号', '订单数量', '制单日期', '领料部门'],
            ...[...this.orderProducts.values()]
              .map((item, index) => [index + 1, item.taskOrder, undefined, item.product, undefined, item.date, item.department]),
            [],  
            [...this.cols, '发料数量', '实发数量',  '退料数', '损耗数', '损耗率'],
            ...this.data.map(item => this.cols.map(c => item[c])),
            ['  发料：       领料：        退料：         收料：         入账：       入账审核：                          ']
          ]
          exportXlsx(data, '领料单')
        }
      }
    })
  </script>
</body>
</html>